<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keywords AI MCP - Login</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 58 58'%3E%3Crect width='58' height='58' rx='29' fill='%23151519'/%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M28.4016 16.2201C28.6068 16.0619 28.8603 15.9646 29.1137 15.9646C29.5 15.9646 29.8621 16.1349 30.0914 16.4391L37.0074 25.3697V32.4996L39.0713 34.568C39.542 35.0426 39.542 35.8213 39.0713 36.2958C38.6006 36.7703 37.8281 36.7703 37.3574 36.2958L34.5934 33.4973V26.2093L28.1844 17.9356V17.9235C27.774 17.4003 27.8705 16.6338 28.4016 16.2201ZM42.7578 35.3992C42.5526 35.3478 42.3581 35.2411 42.1974 35.0791L39.7713 32.6335C39.4937 32.3536 39.373 31.9765 39.4213 31.6236V24.4815H39.3851L32.4329 15.5022C32.2486 15.2672 32.1665 14.983 32.1791 14.7038C31.387 14.5698 30.573 14.5 29.7427 14.5C21.7345 14.5 15.2427 20.9919 15.2427 29C15.2427 37.0081 21.7345 43.5 29.7427 43.5C35.4539 43.5 40.3939 40.1981 42.7578 35.3992Z' fill='%23f9fafc'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --gray1: #151519;
            --gray2: #1e1e23;
            --gray3: #2e2e33;
            --gray4: #b1b3bc;
            --gray5: #f9fafc;
            --primary: #6483f0;
            --primary2: #7590f2;
            --error: #f55656;
            --error-bg: rgba(245, 86, 86, 0.1);
            --success: #73cb98;
            --success-bg: rgba(115, 203, 152, 0.1);
            --info-bg: rgba(100, 131, 240, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray1);
            color: var(--gray5);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            min-height: 100vh;
            padding: 16px 24px;
        }

        .top-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            align-self: stretch;
            flex: 1;
        }

        .back-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            align-self: stretch;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--gray4);
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
            line-height: 20px;
            padding: 6px 8px;
            border-radius: 4px;
            transition: color 0.15s, background 0.15s;
        }

        .back-link:hover {
            color: var(--gray5);
            background: var(--gray2);
        }

        .back-link svg {
            flex-shrink: 0;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 360px;
            gap: 24px;
            margin-top: 120px;
        }

        .logo-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-wrap svg {
            flex-shrink: 0;
        }

        .title-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            align-self: stretch;
            gap: 4px;
        }

        .title {
            font-size: 20px;
            font-weight: 500;
            line-height: 28px;
            color: var(--gray5);
            text-align: center;
        }

        .subtitle-text {
            font-size: 14px;
            font-weight: 400;
            line-height: 20px;
            color: var(--gray4);
            text-align: center;
        }

        /* Buttons */
        .btn-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        button, .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 44px;
            padding: 0 16px;
            border: none;
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 20px;
            cursor: pointer;
            transition: opacity 0.15s, background 0.15s;
            gap: 8px;
        }

        button:hover { opacity: 0.85; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-primary {
            background: var(--primary);
            color: var(--gray5);
        }

        .btn-default {
            background: var(--gray2);
            color: var(--gray4);
            box-shadow: inset 0 0 0 1px var(--gray3);
        }

        .btn-default:hover {
            background: var(--gray3);
            opacity: 1;
        }

        .btn-primary svg, .btn-default svg {
            flex-shrink: 0;
        }

        /* Form */
        .login-form-wrapper {
            display: none;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        .login-form-wrapper.visible {
            display: flex;
        }

        .form-fields {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }

        input[type="email"], input[type="password"], input[type="text"] {
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            background: transparent;
            border: none;
            box-shadow: inset 0 0 0 1px var(--gray3);
            border-radius: 6px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 20px;
            color: var(--gray5);
            outline: none;
            transition: box-shadow 0.15s;
        }

        input::placeholder {
            color: var(--gray4);
        }

        input:focus {
            box-shadow: inset 0 0 0 1px var(--gray4);
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            width: auto;
            height: auto;
            padding: 4px;
            cursor: pointer;
            color: var(--gray4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: var(--gray5);
            opacity: 1;
        }

        /* Messages */
        .error-msg {
            background: var(--error-bg);
            color: var(--error);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 18px;
            display: none;
            width: 100%;
        }

        .status-msg {
            background: var(--info-bg);
            color: var(--primary2);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 18px;
            display: none;
            width: 100%;
        }

        /* Token section */
        #token-section {
            display: none;
        }

        .token-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
            width: 100%;
        }

        .token-block {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .token-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--gray4);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .token-value {
            background: var(--gray2);
            color: var(--gray5);
            padding: 12px;
            border-radius: 6px;
            font-family: 'SF Mono', 'Fira Code', Monaco, Consolas, monospace;
            font-size: 12px;
            line-height: 18px;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: inset 0 0 0 1px var(--gray3);
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            width: auto;
            height: 32px;
            padding: 0 12px;
            font-size: 13px;
            font-weight: 500;
            background: var(--gray2);
            color: var(--gray4);
            border-radius: 4px;
            box-shadow: inset 0 0 0 1px var(--gray3);
            align-self: flex-start;
        }

        .copy-btn:hover {
            color: var(--gray5);
            opacity: 1;
        }

        .copy-btn.copied {
            background: var(--success-bg);
            color: var(--success);
            box-shadow: none;
        }

        /* Footer */
        .footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 16px 0;
        }

        .footer-link {
            color: var(--gray4);
            text-decoration: none;
            font-size: 12px;
            line-height: 16px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: color 0.15s, background 0.15s;
        }

        .footer-link:hover {
            color: var(--gray5);
            background: var(--gray2);
        }

        .footer-separator {
            color: var(--gray3);
            font-size: 12px;
            user-select: none;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .page-container { padding: 16px 16px; }
            .main-content { max-width: 100%; margin-top: 60px; }
        }
    </style>
</head>
<body>
    <!-- Login section -->
    <div id="login-section" class="page-container">
        <div class="top-section">
            <div class="back-row">
                <a href="https://keywordsai.co/" class="back-link">
                    <svg width="12" height="12" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.7 7.71754C11.8657 7.71754 12 7.58322 12 7.41754V6.50239C12 6.3367 11.8657 6.20238 11.7 6.20238L3.63336 6.20238C3.36608 6.20238 3.23223 5.87924 3.42122 5.69025L6.86363 2.24785C6.98078 2.13069 6.98078 1.94074 6.86363 1.82359L6.21213 1.17209C6.09497 1.05494 5.90503 1.05494 5.78787 1.17209L0.212132 6.74783C0.0949745 6.86499 0.0949745 7.05494 0.212132 7.17209L5.78787 12.7478C5.90503 12.865 6.09497 12.865 6.21213 12.7478L6.86363 12.0963C6.98078 11.9792 6.98078 11.7892 6.86363 11.6721L3.42122 8.22967C3.23223 8.04068 3.36608 7.71754 3.63336 7.71754L11.7 7.71754Z" fill="currentColor"/></svg>
                    Home
                </a>
            </div>

            <div class="main-content">
                <div class="logo-wrap">
                    <svg width="58" height="58" viewBox="0 0 58 58" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.5" width="57" height="57" rx="28.5" stroke="#1E1E23"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M28.4016 16.2201C28.6068 16.0619 28.8603 15.9646 29.1137 15.9646C29.5 15.9646 29.8621 16.1349 30.0914 16.4391L37.0074 25.3697V32.4996L39.0713 34.568C39.542 35.0426 39.542 35.8213 39.0713 36.2958C38.6006 36.7703 37.8281 36.7703 37.3574 36.2958L34.5934 33.4973V26.2093L28.1844 17.9356V17.9235C27.774 17.4003 27.8705 16.6338 28.4016 16.2201ZM42.7578 35.3992C42.5526 35.3478 42.3581 35.2411 42.1974 35.0791L39.7713 32.6335C39.4937 32.3536 39.373 31.9765 39.4213 31.6236V24.4815H39.3851L32.4329 15.5022C32.2486 15.2672 32.1665 14.983 32.1791 14.7038C31.387 14.5698 30.573 14.5 29.7427 14.5C21.7345 14.5 15.2427 20.9919 15.2427 29C15.2427 37.0081 21.7345 43.5 29.7427 43.5C35.4539 43.5 40.3939 40.1981 42.7578 35.3992Z" fill="var(--gray5)"/>
                    </svg>
                </div>

                <div class="title-section">
                    <div class="title" id="page-title">Login to Keywords AI MCP</div>
                    <p class="subtitle-text" id="page-subtitle" style="display: none;"></p>
                </div>

                <div id="status" class="status-msg"></div>
                <div id="error" class="error-msg"></div>

                <div class="btn-row" id="auth-buttons">
                    <!-- Google OAuth -->
                    <button class="btn-primary" id="google-btn" type="button">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14.8601 8.1673C14.8601 7.69454 14.8144 7.20653 14.7381 6.74902H8.13477V9.44832H11.9168C11.7643 10.3176 11.2611 11.0801 10.5138 11.5681L12.7708 13.3219C14.0976 12.0866 14.8601 10.2871 14.8601 8.1673Z" fill="var(--gray5)"/><path d="M8.13542 15C10.0264 15 11.6125 14.3748 12.7715 13.3072L10.5145 11.5687C9.8892 11.9957 9.08093 12.2397 8.13542 12.2397C6.30539 12.2397 4.76511 11.0044 4.20085 9.35742L1.88281 11.1417C3.07233 13.5055 5.48187 15 8.13542 15Z" fill="var(--gray5)"/><path d="M4.20016 9.34197C3.91041 8.47271 3.91041 7.52719 4.20016 6.65793L1.88212 4.8584C0.890855 6.84093 0.890855 9.17422 1.88212 11.1415L4.20016 9.34197Z" fill="var(--gray5)"/><path d="M8.13542 3.77581C9.12668 3.76056 10.1027 4.14182 10.8195 4.82808L12.8172 2.81505C11.5515 1.62553 9.87395 0.985016 8.13542 1.00027C5.48187 1.00027 3.07233 2.49479 1.88281 4.85858L4.20085 6.65811C4.76511 4.99583 6.30539 3.77581 8.13542 3.77581Z" fill="var(--gray5)"/></svg>
                        Continue with Google
                    </button>

                    <!-- Email toggle button -->
                    <button class="btn-default" id="email-toggle-btn" type="button">
                        Continue with Email
                    </button>
                </div>

                <!-- Email / Password form (hidden initially) -->
                <div class="login-form-wrapper" id="email-form-wrapper">
                    <form id="login-form">
                        <div class="form-fields">
                            <input type="email" id="email" name="email" placeholder="Enter your email address..." required>
                            <div class="input-wrapper">
                                <input type="password" id="password" name="password" placeholder="Enter your password..." required>
                                <button type="button" class="password-toggle" id="password-toggle" tabindex="-1">
                                    <svg id="eye-icon" width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M1.33 8s2.67-4.67 6.67-4.67S14.67 8 14.67 8s-2.67 4.67-6.67 4.67S1.33 8 1.33 8z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.2"/></svg>
                                    <svg id="eye-off-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" style="display:none"><path d="M9.41 9.41a2 2 0 1 1-2.83-2.83" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><path d="M1.33 1.33l13.34 13.34M6.59 3.58A6.2 6.2 0 0 1 8 3.33c4 0 6.67 4.67 6.67 4.67a11.05 11.05 0 0 1-1.31 1.79m-2.18 1.63A6.2 6.2 0 0 1 8 12.67c-4 0-6.67-4.67-6.67-4.67a11.05 11.05 0 0 1 2.63-3.01" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                            </div>
                            <button type="submit" class="btn-primary" id="login-btn">Sign in</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="footer">
            <a href="https://platform.keywordsai.co/platform/signup" class="footer-link">Create account</a>
            <span class="footer-separator">&middot;</span>
            <a href="https://www.respan.ai/docs/documentation/features/mcp/platform-mcp" class="footer-link">Docs</a>
        </div>
    </div>

    <!-- Token display section -->
    <div id="token-section" class="page-container">
        <div class="top-section">
            <div class="back-row">
                <a href="javascript:void(0)" class="back-link" id="logout-link">
                    <svg width="12" height="12" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.7 7.71754C11.8657 7.71754 12 7.58322 12 7.41754V6.50239C12 6.3367 11.8657 6.20238 11.7 6.20238L3.63336 6.20238C3.36608 6.20238 3.23223 5.87924 3.42122 5.69025L6.86363 2.24785C6.98078 2.13069 6.98078 1.94074 6.86363 1.82359L6.21213 1.17209C6.09497 1.05494 5.90503 1.05494 5.78787 1.17209L0.212132 6.74783C0.0949745 6.86499 0.0949745 7.05494 0.212132 7.17209L5.78787 12.7478C5.90503 12.865 6.09497 12.865 6.21213 12.7478L6.86363 12.0963C6.98078 11.9792 6.98078 11.7892 6.86363 11.6721L3.42122 8.22967C3.23223 8.04068 3.36608 7.71754 3.63336 7.71754L11.7 7.71754Z" fill="currentColor"/></svg>
                    Sign in again
                </a>
            </div>

            <div class="main-content">
                <div class="logo-wrap">
                    <svg width="58" height="58" viewBox="0 0 58 58" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.5" y="0.5" width="57" height="57" rx="28.5" stroke="#1E1E23"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M28.4016 16.2201C28.6068 16.0619 28.8603 15.9646 29.1137 15.9646C29.5 15.9646 29.8621 16.1349 30.0914 16.4391L37.0074 25.3697V32.4996L39.0713 34.568C39.542 35.0426 39.542 35.8213 39.0713 36.2958C38.6006 36.7703 37.8281 36.7703 37.3574 36.2958L34.5934 33.4973V26.2093L28.1844 17.9356V17.9235C27.774 17.4003 27.8705 16.6338 28.4016 16.2201ZM42.7578 35.3992C42.5526 35.3478 42.3581 35.2411 42.1974 35.0791L39.7713 32.6335C39.4937 32.3536 39.373 31.9765 39.4213 31.6236V24.4815H39.3851L32.4329 15.5022C32.2486 15.2672 32.1665 14.983 32.1791 14.7038C31.387 14.5698 30.573 14.5 29.7427 14.5C21.7345 14.5 15.2427 20.9919 15.2427 29C15.2427 37.0081 21.7345 43.5 29.7427 43.5C35.4539 43.5 40.3939 40.1981 42.7578 35.3992Z" fill="var(--gray5)"/>
                    </svg>
                </div>

                <div class="title-section">
                    <div class="title">You're in!</div>
                    <p class="subtitle-text" style="display: block;">Copy your access token or the ready-to-paste MCP config below.</p>
                </div>

                <div class="token-content">
                    <div class="token-block">
                        <div class="token-label">Access Token</div>
                        <div class="token-value" id="access-token"></div>
                        <button class="copy-btn" data-target="access-token">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="5.5" y="5.5" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.2"/><path d="M10.5 5.5V3.5a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2" stroke="currentColor" stroke-width="1.2"/></svg>
                            Copy token
                        </button>
                    </div>

                    <div class="token-block">
                        <div class="token-label">MCP Client Config</div>
                        <div class="token-value" id="mcp-config"></div>
                        <button class="copy-btn" data-target="mcp-config">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none"><rect x="5.5" y="5.5" width="8" height="8" rx="1.5" stroke="currentColor" stroke-width="1.2"/><path d="M10.5 5.5V3.5a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2" stroke="currentColor" stroke-width="1.2"/></svg>
                            Copy config
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <a href="https://www.respan.ai/docs/documentation/features/mcp/platform-mcp" class="footer-link">Docs</a>
        </div>
    </div>

    <script>
    (function () {
        const $ = (sel) => document.querySelector(sel);
        const errorEl = $('#error');
        const statusEl = $('#status');

        // --- Enterprise mode detection ---
        const pageParams = new URLSearchParams(window.location.search);
        let isEnterprise = pageParams.get('enterprise') === 'true';

        // Persist enterprise flag across redirects (e.g. Google OAuth)
        if (isEnterprise) {
            sessionStorage.setItem('enterprise', 'true');
        } else if (sessionStorage.getItem('enterprise') === 'true') {
            isEnterprise = true;
        }

        // --- OAuth mode detection ---
        const oauthMode = pageParams.get('mode') === 'oauth';
        let oauthParams = null;

        if (oauthMode) {
            oauthParams = {
                client_id: pageParams.get('client_id'),
                redirect_uri: pageParams.get('redirect_uri'),
                code_challenge: pageParams.get('code_challenge'),
                state: pageParams.get('state'),
            };
            $('#page-title').textContent = 'Sign in to authorize';
            $('#page-subtitle').textContent = isEnterprise ? 'Enterprise MCP access' : 'Keywords AI MCP access';
            $('#page-subtitle').style.display = 'block';
        }

        // Restore OAuth params from sessionStorage (after Google redirect)
        const savedOAuth = sessionStorage.getItem('oauth_params');
        if (savedOAuth && !oauthMode) {
            try {
                const parsed = JSON.parse(savedOAuth);
                if (parsed.client_id && parsed.redirect_uri && parsed.code_challenge && parsed.state) {
                    oauthParams = parsed;
                    $('#page-title').textContent = 'Sign in to authorize';
                    $('#page-subtitle').textContent = isEnterprise ? 'Enterprise MCP access' : 'Keywords AI MCP access';
                    $('#page-subtitle').style.display = 'block';
                }
            } catch {}
        }

        if (isEnterprise && !oauthMode && !oauthParams) {
            $('#page-title').textContent = 'Login to Enterprise MCP';
        }

        function showError(msg) {
            errorEl.textContent = msg;
            errorEl.style.display = 'block';
            statusEl.style.display = 'none';
        }
        function showStatus(msg) {
            statusEl.textContent = msg;
            statusEl.style.display = 'block';
            errorEl.style.display = 'none';
        }
        function clearMessages() {
            errorEl.style.display = 'none';
            statusEl.style.display = 'none';
        }

        async function handleOAuthCodeExchange(jwt) {
            showStatus('Authorizing...');
            try {
                const resp = await fetch('/oauth/code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jwt,
                        client_id: oauthParams.client_id,
                        redirect_uri: oauthParams.redirect_uri,
                        code_challenge: oauthParams.code_challenge,
                        state: oauthParams.state,
                    }),
                });
                const data = await resp.json();
                if (data.redirect_url) {
                    sessionStorage.removeItem('oauth_params');
                    sessionStorage.removeItem('enterprise');
                    window.location.href = data.redirect_url;
                } else {
                    showError(data.error || 'Failed to generate authorization code.');
                }
            } catch {
                showError('Network error during authorization.');
            }
        }

        function showTokens(access) {
            // If in OAuth mode, exchange the JWT for an auth code and redirect
            if (oauthParams) {
                handleOAuthCodeExchange(access);
                return;
            }

            // Clear enterprise flag from sessionStorage after successful login
            sessionStorage.removeItem('enterprise');

            $('#login-section').style.display = 'none';
            $('#token-section').style.display = 'flex';
            $('#access-token').textContent = access;

            const mcpUrl = isEnterprise
                ? 'https://mcp.keywordsai.co/mcp/enterprise'
                : 'https://mcp.keywordsai.co/mcp';

            const config = JSON.stringify({
                mcpServers: {
                    "keywords-ai": {
                        url: mcpUrl,
                        headers: {
                            Authorization: "Bearer " + access
                        }
                    }
                }
            }, null, 2);
            $('#mcp-config').textContent = config;
        }

        // Copy buttons
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.copy-btn');
            if (!btn) return;
            const target = btn.dataset.target;
            const text = document.getElementById(target).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const svgIcon = btn.querySelector('svg');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '';
                if (svgIcon) btn.appendChild(svgIcon);
                btn.append(' Copied!');
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('copied');
                }, 2000);
            });
        });

        // Logout link
        $('#logout-link').addEventListener('click', () => {
            $('#token-section').style.display = 'none';
            $('#login-section').style.display = 'flex';
            clearMessages();
            // Reset email form
            $('#email-form-wrapper').classList.remove('visible');
            $('#auth-buttons').style.display = 'flex';
        });

        // --- Email toggle ---
        $('#email-toggle-btn').addEventListener('click', () => {
            $('#email-form-wrapper').classList.add('visible');
            $('#email-toggle-btn').style.display = 'none';
            $('#email').focus();
        });

        // --- Password visibility toggle ---
        let passwordVisible = false;
        $('#password-toggle').addEventListener('click', () => {
            passwordVisible = !passwordVisible;
            const input = $('#password');
            input.type = passwordVisible ? 'text' : 'password';
            $('#eye-icon').style.display = passwordVisible ? 'none' : 'block';
            $('#eye-off-icon').style.display = passwordVisible ? 'block' : 'none';
        });

        // --- Auth headers helper ---
        function authHeaders() {
            const h = { 'Content-Type': 'application/json' };
            if (isEnterprise) {
                h['keywords-api-base-url'] = 'https://platform.respan.ai/api';
            }
            return h;
        }

        // --- Google OAuth: start ---
        $('#google-btn').addEventListener('click', async () => {
            clearMessages();
            $('#google-btn').disabled = true;

            // Save OAuth params to sessionStorage before Google redirect
            if (oauthParams) {
                sessionStorage.setItem('oauth_params', JSON.stringify(oauthParams));
            }

            try {
                const redirectUri = window.location.origin + '/login';
                const resp = await fetch('/auth', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ action: 'google_url', redirect_uri: redirectUri })
                });
                const data = await resp.json();
                if (data.authorization_url) {
                    // Store backend cookies for the token exchange step
                    if (data._backend_cookies) {
                        sessionStorage.setItem('_backend_cookies', data._backend_cookies);
                    }
                    window.location.href = data.authorization_url;
                } else {
                    showError(data.error || 'Failed to get Google authorization URL.');
                    $('#google-btn').disabled = false;
                }
            } catch (err) {
                showError('Network error. Please try again.');
                $('#google-btn').disabled = false;
            }
        });

        // --- Google OAuth: callback ---
        async function handleGoogleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            if (!code || !state) return;

            // Don't handle if this is an MCP OAuth mode load
            if (pageParams.get('mode') === 'oauth') return;

            // Clean URL
            window.history.replaceState({}, document.title, '/login');

            showStatus('Exchanging authorization code...');
            $('#google-btn').disabled = true;

            try {
                const backendCookies = sessionStorage.getItem('_backend_cookies') || '';
                sessionStorage.removeItem('_backend_cookies');
                const resp = await fetch('/auth', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ action: 'google_jwt', code, state, _backend_cookies: backendCookies })
                });
                const data = await resp.json();
                if (data.access) {
                    showTokens(data.access);
                } else {
                    const errMsg = data.detail || data.error
                        || (data.non_field_errors && data.non_field_errors[0])
                        || 'Failed to exchange code for token.';
                    showError(errMsg);
                    console.error('Google JWT exchange response:', data);
                    $('#google-btn').disabled = false;
                }
            } catch (err) {
                showError('Network error during token exchange.');
                $('#google-btn').disabled = false;
            }
        }

        // --- Email / Password login ---
        $('#login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessages();

            const email = $('#email').value.trim();
            const password = $('#password').value;
            if (!email || !password) return;

            const btn = $('#login-btn');
            btn.disabled = true;
            btn.textContent = 'Signing in...';

            try {
                const resp = await fetch('/auth', {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ action: 'login', email, password })
                });
                const data = await resp.json();
                if (data.access) {
                    showTokens(data.access);
                } else {
                    showError(data.detail || data.error || 'Invalid email or password.');
                }
            } catch (err) {
                showError('Network error. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign in';
            }
        });

        // On page load, check for Google OAuth callback
        handleGoogleCallback();
    })();
    </script>
</body>
</html>
